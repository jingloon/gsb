<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>GUARD BOARD</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #f5f5f5;
            margin: 0;
            padding: 5.5rem 0 5.5rem;
            /* top + bottom padding for fixed elements */
            text-align: center;
        }

        footer {
            text-align: center;
            font-size: 0.9rem;
            color: #777;
            padding: 1rem 0;
            border-top: 1px solid #ddd;
            margin-top: 1rem;
        }

        .top-menu {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 3.5rem;
            background: #0d1321;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 1rem;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            font-weight: bold;
            font-size: 1.4rem;
            user-select: none;
        }

        .branding {
            user-select: none;
            color: white;
        }

        .right-buttons {
            display: flex;
            gap: 0.5rem;
        }

        .right-buttons button {
            padding: 0.5rem 1rem;
            font-size: 0.7rem;
            border: none;
            border-radius: 5px;
            background-color: #8c9399;
            color: white;
            cursor: pointer;
        }

        .right-buttons .reset {
            background-color: #da3226;
        }

        .right-buttons #undoBtn {
            background-color: #4a0071;
            /* Dark Purple */
        }

        .right-buttons #undoBtn:disabled {
            background-color: #8c9399;
            /* Default grey */
            cursor: not-allowed;
        }

        /* Scoring fields fixed below menu */
        .scoring-rules {
            position: absolute;
            top: 3.5rem;
            left: 0;
            right: 0;
            background: #d8d8d8;
            display: flex;
            justify-content: center;
            gap: 1rem;
            padding: 0.7rem 1rem;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            z-index: 999;
            user-select: none;
            font-weight: bold;
            font-size: 1rem;
        }

        .scoring-rules div {
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }

        .scoring-rules input {
            width: 50px;
            text-align: center;
            padding: 0.2rem 0.3rem;
            font-size: 1rem;
            border-radius: 4px;
            border: 1px solid #ccc;
        }

        /* Round Order fixed at bottom */
        #roundOrder {
            position: fixed;
            bottom: 2.2rem;
            left: 0;
            right: 0;
            background: #7fc6a4;
            font-size: 1rem;
            font-weight: bold;
            padding: 0.4rem 1rem;
            box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.2);
            user-select: none;
            z-index: 1000;
            overflow: hidden;
        }

        #lastUpdate {
            position: fixed;
            bottom: 0;
            /* Adjust based on roundOrder's height */
            left: 0;
            right: 0;
            background: #d8d8d8;
            /* Match scoring-rules background */
            color: black;
            /* Font color back to black */
            font-size: 1rem;
            padding: 0.4rem 1rem;
            box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.1);
            user-select: none;
            z-index: 1000;
            text-align: center;
            overflow: hidden;
            cursor: pointer;
        }

        .flash-sweep::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(to right,
                    transparent 0%,
                    rgba(255, 255, 255, 0.6) 50%,
                    transparent 100%);
            transform: translateX(-100%);
            animation: lens-flare 0.75s ease-out;
        }

        @keyframes lens-flare {
            from {
                transform: translateX(-100%);
            }

            to {
                transform: translateX(100%);
            }
        }


        .scoreboard {
            margin-top: 3.5rem;
            /* space for fixed menu + scoring fields */
            margin-bottom: 3.5rem;
            /* space for round order */
            display: grid;
            gap: 1rem;
            width: 100%;
            max-width: 1200px;
            margin-left: auto;
            margin-right: auto;
            padding: 0 1rem;
            box-sizing: border-box;
        }

        /* 3 players: 3 columns x 1 row */
        .scoreboard.three-players {
            grid-template-columns: repeat(2, 1fr);
            grid-auto-rows: minmax(150px, auto);
        }

        /* 4 players: 2 columns x 2 rows */
        .scoreboard.four-players {
            grid-template-columns: repeat(2, 1fr);
            grid-template-rows: repeat(2, minmax(150px, auto));
        }

        .player-card {
            background: white;
            padding: 1rem;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            user-select: none;
        }

        .player-card.positive {
            border: 2px solid rgb(22, 168, 22);
        }

        .player-card.negative {
            border: 2px solid rgb(133, 4, 4);
        }

        .player-card .action-buttons {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .player-card .action-buttons button {
            min-width: 50px;
            padding: 0.6rem 0.6rem;
            font-size: 1rem;
            border-radius: 4px;
            /* Let width be automatic based on content */
            flex-grow: 0;
            flex-shrink: 0;
        }

        .score {
            font-size: 2.2rem;
            margin: 1rem 0;
            cursor: pointer;
            user-select: none;
        }

        .score-increase {
            animation: score-increase-animation 3s ease;
        }

        .score-decrease {
            animation: score-decrease-animation 3s ease;
        }

        @keyframes score-increase-animation {
            0% {
                color: #4CAF50;
                transform: scale(1.2);
            }

            /* Green */
            100% {
                color: black;
                transform: scale(1);
            }
        }

        @keyframes score-decrease-animation {
            0% {
                color: #da3226;
                transform: scale(1.2);
            }

            /* Red */
            100% {
                color: black;
                transform: scale(1);
            }
        }


        button {
            margin: 0.2rem;
            padding: 0.5rem 1rem;
            font-size: 1rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            user-select: none;
        }

        .win {
            background-color: #4CAF50;
            color: white;
        }

        .foul {
            background-color: #da3226;
            color: white;
        }

        .bc {
            background: linear-gradient(45deg, #FFD700, #FFC300, #FFB700);
            color: white;
            border: 1px solid #b38600;
            box-shadow: 0 0 8px #FFD700, inset 0 1px 1px rgba(255, 255, 255, 0.6);
        }

        .bc:disabled {
            background: #555555;
            color: #666;
            border: none;
            cursor: not-allowed;
            box-shadow: none;
        }

        .name-label {
            font-size: 1.2rem;
            cursor: pointer;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            user-select: none;
            min-width: 100px;
            text-align: center;
        }

        .name-input {
            font-size: 1.2rem;
            padding: 0.2rem 0.5rem;
            width: 100%;
            box-sizing: border-box;
            text-align: center;
            border-radius: 4px;
            border: 1px solid #ccc;
        }


        @keyframes fall {
            0% {
                transform: translateY(-50px) rotate(0deg);
                opacity: 1;
            }

            100% {
                transform: translateY(100vh) rotate(360deg);
                opacity: 0;
            }
        }

        .leaf {
            position: fixed;
            top: 0;
            pointer-events: none;
            user-select: none;
            font-size: 24px;
            animation-name: fall;
            animation-timing-function: linear;
            animation-fill-mode: forwards;
            z-index: 9999;
        }

        .firework-piece {
            position: absolute;
            font-size: 24px;
            pointer-events: none;
            animation: explode 800ms ease-out forwards;
            opacity: 0;
            z-index: 9999;
        }

        @keyframes explode {
            0% {
                transform: translate(0, 0) scale(1);
                opacity: 1;
            }

            100% {
                transform: translate(var(--x), var(--y)) scale(0.5);
                opacity: 0;
            }
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            background-color: #fefefe;
            margin: 10% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 600px;
            border-radius: 8px;
            text-align: left;
        }

        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .modal-footer {
            padding-top: 1rem;
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
        }

        .modal-footer button {
            padding: 0.6rem 1.2rem;
            font-size: 1rem;
            border-radius: 5px;
            border: none;
            color: white;
        }

        .modal-confirm-btn {
            background-color: #4d9dbd;
            /* Green */
        }

        .modal-cancel-btn {
            background-color: #828282;
            /* Red */
        }
    </style>
</head>

<body>
    <div class="top-menu">
        <div id="branding" class="branding">Guard.</div>
        <div class="right-buttons">
            <button id="togglePlayersBtn">3P</button>
            <button id="undoBtn">Undo</button>
            <button class="reset" onclick="confirmReset()">Reset</button>
        </div>
    </div>

    <div class="scoring-rules">
        <div>Foul: <input type="number" id="foulPoints" value="1" /></div>
        <div>Win: <input type="number" id="winPoints" value="3" /></div>
        <div>BC: <input type="number" id="bcPoints" value="5" /></div>
    </div>

    <div class="scoreboard three-players" id="scoreboard">
        <!-- Player cards inserted here -->
    </div>

    <div id="lastUpdate"></div>
    <div id="roundOrder">Round Order: P1 ‚Üí P2 ‚Üí P3</div>

    <div id="gameLogModal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <div id="gameLogContent"></div>
            <div class="modal-footer" id="gameLogFooter"></div>
        </div>
    </div>

    <script>
        let scores = {};
        let order = [1, 2, 3];
        let isFourPlayers = false;

        // Logs for Undo functionality
        let historyLog = [];
        let scoreLog = [];
        let orderLog = [];


        function createPlayerCard(player) {
            const card = document.createElement('div');
            card.classList.add('player-card');
            card.id = `playerCard${player}`;

            // Name label with click-to-edit functionality
            card.innerHTML = `
        <div class="name-label" id="nameLabel${player}">P${player}</div>
        <input class="name-input" id="nameInput${player}" style="display:none" />
        <div class="score" id="score${player}">0</div>
        <div class="action-buttons">
            <button class="win" onclick="changeScore(${player}, 'win', this)">Win</button> 
            <button class="foul" onclick="changeScore(${player}, 'foul', this)">Foul!</button>
            <button class="bc" onclick="changeScore(${player}, 'bc', this)">BC</button>
            <button class="bc" onclick="changeScore(${player}, 'gb', this)">GB</button>
        </div>
      `;

            document.getElementById("scoreboard").appendChild(card);

            // Initialize score only if it's not already loaded from localStorage
            if (scores[player] === undefined) {
                scores[player] = 0;
            }

            // Name editing logic
            const nameLabel = document.getElementById(`nameLabel${player}`);
            const nameInput = document.getElementById(`nameInput${player}`);

            nameLabel.addEventListener('click', () => {
                nameLabel.style.display = 'none';
                nameInput.style.display = 'block';
                nameInput.value = nameLabel.textContent;
                nameInput.focus();
                nameInput.select();
            });

            nameInput.addEventListener('blur', () => {
                let val = nameInput.value.trim();
                if (val === '') val = `P${player}`;
                nameLabel.textContent = val;
                nameLabel.style.display = 'block';
                nameInput.style.display = 'none';
                updateRoundOrder();
                saveGameState();
            });

            nameInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    nameInput.blur();
                } else if (e.key === 'Escape') {
                    nameInput.value = nameLabel.textContent;
                    nameInput.blur();
                }
            });

            addScoreClickListener(player);
        }

        function removePlayerCard(player) {
            const card = document.getElementById(`playerCard${player}`);
            if (card) card.remove();
            delete scores[player];
        }

        function triggerFlash(elementId) {
            const elem = document.getElementById(elementId);
            elem.classList.remove('flash-sweep');
            void elem.offsetWidth; // Force reflow
            elem.classList.add('flash-sweep');
        }

        function formatTime(date) {
            const now = new Date(date);
            let hours = now.getHours();
            let minutes = now.getMinutes();
            const ampm = hours >= 12 ? 'pm' : 'am';
            hours = hours % 12;
            hours = hours ? hours : 12; // the hour '0' should be '12'
            minutes = minutes < 10 ? '0' + minutes : minutes;
            return `${hours}:${minutes}${ampm}`;
        }


        function updateLastUpdate(historyEntry) {
            const timeString = formatTime(historyEntry.time);
            document.getElementById('lastUpdate').textContent = `Last Update (${timeString}): ${historyEntry.text}`;
            triggerFlash('lastUpdate');
        }

        function updateRoundOrder() {
            const names = order.map(i => {
                const label = document.getElementById(`nameLabel${i}`);
                return label ? label.textContent : `Player ${i}`;
            });
            document.getElementById("roundOrder").textContent = `Round Order: ${names.join(" ‚Üí ")}`;
            triggerFlash('roundOrder');
        }

        function getPointsFor(action) {
            if (action === 'win') return parseInt(document.getElementById('winPoints').value) || 0;
            if (action === 'foul') return parseInt(document.getElementById('foulPoints').value) || 0;
            if (action === 'bc') return parseInt(document.getElementById('bcPoints').value) || 0;
            return 0;
        }

        function logState(message) {
            historyLog.push({
                text: message,
                time: new Date()
            });
            scoreLog.push(JSON.parse(JSON.stringify(scores)));
            orderLog.push([...order]);
            document.getElementById('undoBtn').disabled = false;
        }

        function changeScore(player, action, element) {
            let message = '';
            const playerName = document.getElementById(`nameLabel${player}`).textContent;

            const idx = order.indexOf(player);

            if (action === 'win') {
                const points = getPointsFor(action);
                scores[player] += points;
                const prevPlayerIndex = (idx - 1 + order.length) % order.length;
                const prevPlayer = order[prevPlayerIndex];
                scores[prevPlayer] -= points;
                const prevPlayerName = document.getElementById(`nameLabel${prevPlayer}`).textContent;
                message = `${playerName} won ${prevPlayerName}.`;
                updateOrderAfterWin(player);
            } else if (action === 'foul') {
                const points = getPointsFor(action);
                scores[player] -= points;
                const prevPlayerIndex = (idx - 1 + order.length) % order.length;
                const prevPlayer = order[prevPlayerIndex];
                scores[prevPlayer] += points;
                const prevPlayerName = document.getElementById(`nameLabel${prevPlayer}`).textContent;
                message = `${playerName} fouled to ${prevPlayerName}.`;
            } else if (action === 'bc' || action === 'gb') {
                const points = (action === 'bc') ? getPointsFor('bc') : getPointsFor('win');
                let others = order.filter(p => p !== player);
                let totalLoss = 0;
                for (let p of others) {
                    scores[p] -= points;
                    totalLoss += points;
                }
                scores[player] += totalLoss;

                if (element) {
                    launchFireworksAtElement(element);
                    rainLeaves();
                }
                if (action === 'bc') {
                    message = `${playerName} broke clear!`;
                } else { // gb
                    message = `${playerName} golden break!`;
                }
            }

            logState(message);
            updateLastUpdate(historyLog[historyLog.length - 1]);
            console.log(`Action: ${message}`, '| Scores After:', scores);
            saveGameState();


            updateAllScores();
            updateSpecialActionButtons();
        }

        function updateAllScores(scoresToCompareAgainst) {
            const oldScores = scoresToCompareAgainst || (scoreLog.length > 1 ? scoreLog[scoreLog.length - 2] : {});

            for (let i in scores) {
                const scoreElem = document.getElementById(`score${i}`);
                if (scoreElem) {
                    const oldScore = oldScores[i] !== undefined ? oldScores[i] : 0;
                    const newScore = scores[i];

                    scoreElem.textContent = newScore;

                    scoreElem.classList.remove('score-increase', 'score-decrease');
                    void scoreElem.offsetWidth; // Force reflow

                    if (newScore > oldScore) {
                        scoreElem.classList.add('score-increase');
                    } else if (newScore < oldScore) {
                        scoreElem.classList.add('score-decrease');
                    }
                }

                const card = document.getElementById(`playerCard${i}`);
                if (card) {
                    card.classList.remove('positive', 'negative');
                    if (scores[i] > 0) card.classList.add('positive');
                    else if (scores[i] < 0) card.classList.add('negative');
                }
            }
            updateRoundOrder();
        }

        function updateOrderAfterWin(winner) {
            const idx = order.indexOf(winner);
            if (!isFourPlayers) {
                // 3-player logic
                if (idx === 0) order = [order[0], order[2], order[1]];
                else if (idx === 1) order = [order[1], order[0], order[2]];
                else order = [order[2], order[1], order[0]];
            } else {
                // 4-player logic
                if (idx === 0) order = [order[0], order[3], order[1], order[2]];
                else if (idx === 1) order = [order[1], order[0], order[2], order[3]];
                else if (idx === 2) order = [order[2], order[1], order[3], order[0]];
                else order = [order[3], order[2], order[0], order[1]];
            }
        }

        function updateSpecialActionButtons() {
            for (let i in scores) {
                const card = document.getElementById(`playerCard${i}`);
                if (!card) continue;
                const specialButtons = card.querySelectorAll('.bc');
                if (specialButtons.length > 0) {
                    specialButtons.forEach(btn => {
                        btn.disabled = (parseInt(i) !== order[0]);
                    });
                }
            }
        }

        function confirmReset() {
            showConfirmation("Are you sure you want to reset the game? This action cannot be undone.", resetScores);
        }

        function resetScores() {
            const message = 'Game Reset';
            historyLog = [];
            scoreLog = [];
            orderLog = [];

            for (let i in scores) scores[i] = 0;

            logState(message);

            console.log(`Action: ${message}`, '| All scores reset.');
            updateLastUpdate(historyLog[historyLog.length - 1]);
            updateAllScores();

            document.getElementById('undoBtn').disabled = true;
            localStorage.removeItem('guardBoardGameState');
            console.log('Game state cleared from localStorage.');
        }


        function togglePlayersMode() {
            const futurePlayerCount = isFourPlayers ? 3 : 4;
            showConfirmation(`Change mode to ${futurePlayerCount} players? This will reset the scores.`, () => {
                resetScores();

                if (isFourPlayers) {
                    removePlayerCard(4);
                    order = [1, 2, 3];
                    isFourPlayers = false;
                    document.getElementById('togglePlayersBtn').textContent = '3P';
                    document.getElementById('scoreboard').classList.remove('four-players');
                    document.getElementById('scoreboard').classList.add('three-players');
                } else {
                    createPlayerCard(4);
                    order = [1, 2, 3, 4];
                    isFourPlayers = true;
                    document.getElementById('togglePlayersBtn').textContent = '4P';
                    document.getElementById('scoreboard').classList.remove('three-players');
                    document.getElementById('scoreboard').classList.add('four-players');
                }

                updateAllScores();
                updateSpecialActionButtons();
                saveGameState();
            });
        }

        function addScoreClickListener(player) {
            const scoreElem = document.getElementById(`score${player}`);
            if (!scoreElem) return;
            scoreElem.addEventListener('click', () => {
                const playerName = document.getElementById(`nameLabel${player}`).textContent;
                let newScore = prompt(`Enter new score for ${playerName}:`, scores[player]);
                if (newScore === null) return;
                newScore = newScore.trim();
                if (/^-?\d+$/.test(newScore)) {
                    const message = `${playerName}'s score manually set to ${newScore}.`;
                    scores[player] = parseInt(newScore);
                    logState(message);
                    updateLastUpdate(historyLog[historyLog.length - 1]);
                    console.log(`Action: ${message}`, '| Scores After:', scores);
                    updateAllScores();
                    updateSpecialActionButtons();
                    saveGameState();
                } else {
                    alert("Please enter a valid integer number.");
                }
            });
        }

        function undoLastAction() {
            if (historyLog.length <= 1) {
                alert("Nothing to undo.");
                return;
            }

            const lastActionMessage = historyLog[historyLog.length - 1].text;
            showConfirmation(`Are you sure you want to undo this action?<br><br><i>"${lastActionMessage}"</i>`, () => {
                const undoneScores = JSON.parse(JSON.stringify(scoreLog[scoreLog.length - 1]));

                historyLog.pop();
                scoreLog.pop();
                orderLog.pop();

                const previousScores = scoreLog[scoreLog.length - 1];
                const previousOrder = orderLog[orderLog.length - 1];
                const previousMessage = historyLog[historyLog.length - 1];

                scores = JSON.parse(JSON.stringify(previousScores));
                order = [...previousOrder];

                updateAllScores(undoneScores);
                updateSpecialActionButtons();
                updateLastUpdate(previousMessage);
                console.log("Undo successful. Reverted to previous state:", {
                    scores,
                    order
                });

                if (historyLog.length <= 1) {
                    document.getElementById('undoBtn').disabled = true;
                }
                saveGameState();
            });
        }

        function saveGameState() {
            const gameState = {
                playerNames: {},
                scores: scores,
                order: order,
                isFourPlayers: isFourPlayers,
                historyLog: historyLog,
                scoreLog: scoreLog,
                orderLog: orderLog
            };
            // Save player names separately as they are in the DOM
            for (let i = 1; i <= (isFourPlayers ? 4 : 3); i++) {
                const nameLabel = document.getElementById(`nameLabel${i}`);
                if (nameLabel) {
                    gameState.playerNames[i] = nameLabel.textContent;
                }
            }
            localStorage.setItem('guardBoardGameState', JSON.stringify(gameState));
            console.log('Game state saved to localStorage.');
        }

        function loadGameState() {
            const savedState = localStorage.getItem('guardBoardGameState');
            if (savedState) {
                const gameState = JSON.parse(savedState);

                scores = gameState.scores || {};
                order = gameState.order || [1, 2, 3];
                isFourPlayers = gameState.isFourPlayers || false;
                historyLog = gameState.historyLog || [];
                scoreLog = gameState.scoreLog || [];
                orderLog = gameState.orderLog || [];

                // Recreate player cards based on loaded state
                const scoreboard = document.getElementById("scoreboard");
                scoreboard.innerHTML = ''; // Clear existing cards

                const playerCount = isFourPlayers ? 4 : 3;
                for (let i = 1; i <= playerCount; i++) {
                    createPlayerCard(i);
                }

                // Set player names
                if (gameState.playerNames) {
                    for (let i in gameState.playerNames) {
                        const nameLabel = document.getElementById(`nameLabel${i}`);
                        if (nameLabel) {
                            nameLabel.textContent = gameState.playerNames[i];
                        }
                    }
                }

                document.getElementById('togglePlayersBtn').textContent = isFourPlayers ? '4 Players' : '3 Players';
                scoreboard.classList.remove('three-players', 'four-players');
                scoreboard.classList.add(isFourPlayers ? 'four-players' : 'three-players');

                updateAllScores();
                updateRoundOrder();
                updateSpecialActionButtons();
                if (historyLog.length > 0) {
                    updateLastUpdate(historyLog[historyLog.length - 1]);
                } else {
                    document.getElementById('lastUpdate').textContent = 'No recent updates.';
                }
                document.getElementById('undoBtn').disabled = historyLog.length <= 1;

                console.log('Game state loaded from localStorage.');
                return true;
            }
            return false;
        }

        function init() {
            document.getElementById('togglePlayersBtn').addEventListener('click', togglePlayersMode);
            document.getElementById('undoBtn').addEventListener('click', undoLastAction);
            document.getElementById('lastUpdate').addEventListener('click', showGameLog);
            document.querySelector('.reset').addEventListener('click', confirmReset);

            if (!loadGameState()) {
                // If no saved state, initialize default 3 players
                [1, 2, 3].forEach(createPlayerCard);
                const message = 'Game Started';
                logState(message);
                updateLastUpdate(historyLog[historyLog.length - 1]);
                console.log(`Action: ${message}`, '| Initial State:', {
                    scores,
                    order
                });
                document.getElementById('undoBtn').disabled = true;
            }

            updateRoundOrder();
            updateSpecialActionButtons();
        }

        function showConfirmation(message, onConfirm) {
            const modal = document.getElementById('gameLogModal');
            const contentEl = document.getElementById('gameLogContent');
            const footerEl = document.getElementById('gameLogFooter');

            contentEl.innerHTML = `<p>${message}</p>`;
            footerEl.innerHTML = `
                <button class="modal-confirm-btn">Confirm</button>
                <button class="modal-cancel-btn">Cancel</button>
            `;
            modal.style.display = 'block';

            const confirmBtn = footerEl.querySelector('.modal-confirm-btn');
            const cancelBtn = footerEl.querySelector('.modal-cancel-btn');
            const closeBtn = modal.querySelector('.close-button');

            const closeModal = () => {
                modal.style.display = 'none';
                contentEl.innerHTML = '';
                footerEl.innerHTML = '';
            };

            confirmBtn.onclick = () => {
                onConfirm();
                closeModal();
            };
            cancelBtn.onclick = closeModal;
            closeBtn.onclick = closeModal;
            window.onclick = (event) => {
                if (event.target == modal) {
                    closeModal();
                }
            };
        }

        function showGameLog() {
            const modal = document.getElementById('gameLogModal');
            const contentEl = document.getElementById('gameLogContent');
            const footerEl = document.getElementById('gameLogFooter');
            footerEl.innerHTML = ''; // Clear footer for log view

            // Calculate stats
            let racksPlayed = 0;
            const playerStats = {};
            for (let i = 1; i <= (isFourPlayers ? 4 : 3); i++) {
                playerStats[i] = {
                    wins: 0,
                    fouls: 0,
                    bcgb: 0
                };
            }

            historyLog.forEach(entry => {
                const text = entry.text.toLowerCase();
                if (text.includes('won') || text.includes('broke clear') || text.includes('golden break')) {
                    racksPlayed++;
                }

                for (let i = 1; i <= (isFourPlayers ? 4 : 3); i++) {
                    const playerName = document.getElementById(`nameLabel${i}`).textContent.toLowerCase();
                    if (text.startsWith(playerName)) {
                        if (text.includes('won')) playerStats[i].wins++;
                        if (text.includes('fouled')) playerStats[i].fouls++;
                        if (text.includes('broke clear') || text.includes('golden break')) playerStats[i].bcgb++;
                    }
                }
            });

            // Build content string
            let content = `<h3>Game Summary</h3>`;
            content += `<p><b>Racks Played:</b> ${racksPlayed}</p>`;
            content += '<ul>';
            for (let i = 1; i <= (isFourPlayers ? 4 : 3); i++) {
                const playerName = document.getElementById(`nameLabel${i}`).textContent;
                const stats = playerStats[i];
                content += `<li><b>${playerName}:</b> ${stats.wins} Wins, ${stats.fouls} Fouls, ${stats.bcgb} BC/GB</li>`;
            }
            content += '</ul>';
            content += '<hr>';
            content += '<h3>Action History</h3>';
            content += '<ul>';
            historyLog.forEach(entry => {
                content += `<li>(${formatTime(entry.time)}) ${entry.text}</li>`;
            });
            content += '</ul>';

            contentEl.innerHTML = content;
            modal.style.display = 'block';

            // Close modal logic
            const closeBtn = modal.querySelector('.close-button');
            closeBtn.onclick = () => modal.style.display = 'none';
            window.onclick = (event) => {
                if (event.target == modal) {
                    modal.style.display = 'none';
                }
            };
        }


        function createLeaf() {
            const leaf = document.createElement('div');
            leaf.classList.add('leaf');

            const emojis = ['ü§ë', 'üçÄ', 'üí∞'];
            leaf.textContent = emojis[Math.floor(Math.random() * emojis.length)];

            leaf.style.left = Math.random() * window.innerWidth + 'px';
            const size = 16 + Math.random() * 24;
            leaf.style.fontSize = size + 'px';
            const duration = 3 + Math.random() * 4;
            leaf.style.animationDuration = duration + 's';
            leaf.style.animationDelay = (Math.random() * 2) + 's';
            leaf.style.transform = `rotate(${Math.random() * 360}deg)`;

            document.body.appendChild(leaf);

            leaf.addEventListener('animationend', () => {
                leaf.remove();
            });
        }

        function rainLeaves() {
            let count = 0;
            const interval = setInterval(() => {
                createLeaf();
                count++;
                if (count >= 18) clearInterval(interval);
            }, 50);
        }

        document.getElementById('branding').addEventListener('click', rainLeaves);


        function launchFireworksAtElement(elem) {
            const rect = elem.getBoundingClientRect();
            const originX = rect.left + rect.width / 2;
            const originY = rect.top + rect.height / 2;

            const emojis = ['ü§ë', 'üçÄ', 'üí∞'];
            const count = 50;

            for (let i = 0; i < count; i++) {
                const span = document.createElement('span');
                span.classList.add('firework-piece');
                span.textContent = emojis[Math.floor(Math.random() * emojis.length)];
                document.body.appendChild(span);

                const angle = Math.random() * 2 * Math.PI;
                const radius = 100 + Math.random() * 50;
                const x = Math.cos(angle) * radius;
                const y = Math.sin(angle) * radius;

                span.style.left = originX + 'px';
                span.style.top = originY + 'px';
                span.style.setProperty('--x', `${x}px`);
                span.style.setProperty('--y', `${y}px`);

                span.addEventListener('animationend', () => span.remove());
            }
        }


        init();
    </script>
    <footer>¬© 2025 Guard Scoreboard. <br /> <i>for the Degens. Made with Kopi Peng ‚òï. </i></footer>
</body>

</html>
